
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>2. Introduction to Testing &#8212; Trading</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Time Series" href="104_TimeSeries.html" />
    <link rel="prev" title="1. Simple Time Series (Stock Prices)" href="101_SimpleTimeSeries.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Trading</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to my Trading Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Section 1 - Applications
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="101_SimpleTimeSeries.html">
   1. Simple Time Series (Stock Prices)
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   2. Introduction to Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="104_TimeSeries.html">
   3. Time Series
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Section 2 - Statistics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="200_Introduction.html">
   4. Statistics
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/isaac-flath/trading/main?urlpath=tree/trading/102_BasicTesting.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/isaac-flath/trading/blob/main/trading/102_BasicTesting.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/isaac-flath/trading"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/isaac-flath/trading/issues/new?title=Issue%20on%20page%20%2F102_BasicTesting.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/isaac-flath/trading/edit/main/trading/102_BasicTesting.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/102_BasicTesting.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   2.1. Background
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-data-should-you-use-for-testing">
   2.2. What data should you use for testing?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-set">
     2.2.1. Training Set
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validation-set">
     2.2.2. Validation Set
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-set">
     2.2.3. Test Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-metric-should-you-use-for-testing">
   2.3. What metric should you use for testing?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dollars">
     2.3.1. Dollars
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#percent-return">
     2.3.2. Percent Return
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-return">
     2.3.3. Log Return
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#statistical-tests">
   2.4. Statistical Tests
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#motivation">
     2.4.1. Motivation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bootstrapping">
     2.4.2. Bootstrapping
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       2.4.2.1. Background
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#bootstrap-test">
       2.4.2.2. Bootstrap Test
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#null-hypothesis-model">
         2.4.2.2.1. Null Hypothesis Model
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#alternate-hypothesis-model">
         2.4.2.2.2. Alternate Hypothesis Model
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#calculate-returns">
         2.4.2.2.3. Calculate Returns
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#statistical-test">
         2.4.2.2.4. Statistical Test
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#plot-experiment">
         2.4.2.2.5. Plot Experiment
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#what-if-we-hold-for-less-time">
         2.4.2.2.6. What if we hold for less time?
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#what-if-we-use-a-larger-period-size-for-momentum">
         2.4.2.2.7. What if we use a larger period size for momentum?
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Introduction to Testing</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   2.1. Background
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-data-should-you-use-for-testing">
   2.2. What data should you use for testing?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-set">
     2.2.1. Training Set
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validation-set">
     2.2.2. Validation Set
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-set">
     2.2.3. Test Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-metric-should-you-use-for-testing">
   2.3. What metric should you use for testing?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dollars">
     2.3.1. Dollars
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#percent-return">
     2.3.2. Percent Return
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-return">
     2.3.3. Log Return
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#statistical-tests">
   2.4. Statistical Tests
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#motivation">
     2.4.1. Motivation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bootstrapping">
     2.4.2. Bootstrapping
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       2.4.2.1. Background
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#bootstrap-test">
       2.4.2.2. Bootstrap Test
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#null-hypothesis-model">
         2.4.2.2.1. Null Hypothesis Model
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#alternate-hypothesis-model">
         2.4.2.2.2. Alternate Hypothesis Model
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#calculate-returns">
         2.4.2.2.3. Calculate Returns
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#statistical-test">
         2.4.2.2.4. Statistical Test
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#plot-experiment">
         2.4.2.2.5. Plot Experiment
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#what-if-we-hold-for-less-time">
         2.4.2.2.6. What if we hold for less time?
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#what-if-we-use-a-larger-period-size-for-momentum">
         2.4.2.2.7. What if we use a larger period size for momentum?
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="introduction-to-testing">
<h1><span class="section-number">2. </span>Introduction to Testing<a class="headerlink" href="#introduction-to-testing" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">qqr</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fastcore.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">polygon</span> <span class="kn">import</span> <span class="n">RESTClient</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">view_source_code</span><span class="p">,</span> <span class="n">get_dollars</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="background">
<h2><span class="section-number">2.1. </span>Background<a class="headerlink" href="#background" title="Permalink to this headline">#</a></h2>
<p>In Chapter 1 we created models and created actions we want to take for multiple approaches.  The question now is, how do we know if they are profitable?  How should we measure them?  How do we know if we simply got lucky, or if they are reliable?</p>
<p>As we mentioned in chapter 2, testing is the most important part of the process.  If done well you have a good way to determine what strategies should be implemented, and if done poorly you run the risk of implementing non-profitable strategies.  I believe you should strive to never sacrifice testing principles because effective testing is your <strong>only</strong> objective indication to whether you are doing something useful or not.  Without effective testing you are “flying blind”.</p>
<p>This chapter will lay the groundwork and cover the basics of testing.  The goal of this chapter is to introduce concept and the three core things that need to be carefully considered for effective testing.</p>
<ol class="simple">
<li><p>What data should you use for testing?</p></li>
<li><p>What metric should you use for testing?</p></li>
<li><p>What test should you use?</p></li>
</ol>
<p>In this chapter we are going to walk through the concepts to see each step and understand the importance.  In the next chapter we are going apply our knowledge to build a better structured solution and framework that we can use through the remainder of the book.</p>
</section>
<section id="what-data-should-you-use-for-testing">
<h2><span class="section-number">2.2. </span>What data should you use for testing?<a class="headerlink" href="#what-data-should-you-use-for-testing" title="Permalink to this headline">#</a></h2>
<p>The first question we have to ask is what data to we use for testing?  Ideally we have 3 subsets of our data (training, validation, and test).  Let’s go through what they are used for and why they are important.</p>
<section id="training-set">
<h3><span class="section-number">2.2.1. </span>Training Set<a class="headerlink" href="#training-set" title="Permalink to this headline">#</a></h3>
<p>The training set is unique because it has no restrictions on what we can do with it.  We can look at any piece of data in it.  We can normalize data using values in the training set.  We can train machine learning models on the training set.  This is often the largest subset of our data.</p>
<p>This training set is pretty explanatory - we use this for understanding our data and developing our model.</p>
<p>We can load it in using the same method as we did in chapter 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;eod-quotemedia.csv&#39;</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;adj_close&#39;</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-1-1&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="validation-set">
<h3><span class="section-number">2.2.2. </span>Validation Set<a class="headerlink" href="#validation-set" title="Permalink to this headline">#</a></h3>
<p>The goal of creating a trading strategy is to have it perform well on data that it was not developed using.  We may use data from 2015 - 2020 to create a trading strategy, but the goal is to apply it to 2021 and 2022 to make a profit.</p>
<p>Because we want our model to perform on <em>unseen</em> data, we create some restriction to how we use the validation set.  We do not train any models on it, and we do not use statistics or data from the validation set when creating our model.  It’s data our model has never seen.  The validation set is something we can only use to see how well our strategy or model performs.</p>
<p>The entire purpose of the validation set is to give us unseen data to evaluate our approaches on.  By having this separate validation set we can more accurately determine what works and what doesn’t.</p>
<p>We can get our validation set using the same method as we did in chapter 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-1-1&#39;</span><span class="p">):]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-set">
<h3><span class="section-number">2.2.3. </span>Test Set<a class="headerlink" href="#test-set" title="Permalink to this headline">#</a></h3>
<p>The Test set is very similar to the validation set, but it takes things a step further.  It has further restrictions in that is is the final model step before deployment.  The main difference is how often you can use it.  For the validation set, you can test anything on the validation set as many times as you want.  For the test set you only get to look at the test set once for your particular approach.</p>
<p>For example, you may try 300 different approaches and parameter changes to your strategy to see what works best.  You can check the profitability on each of them using the validation set.  Then once you have chosen a strategy, you do a final check to ensure it also performs on the test set.  Once you have done that you need a new test set or your project is over.</p>
<p>The reason this is important is that you want to ensure that you didn’t get lucky and find a configuration out of your 300 attempts that just happens to work on the validation set but doesn’t work elsewhere.  If you try enough combinations eventually you will find something that works, but the test set gives you confidence that your model works because it’s a good strategy and not that you just tried enough things to find something that works on coincidence.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Many people re-use or have more lax rules on the test set.  Many people do not use one at all.  In this text I am laying out the ideal state I believe we should strive for.  If you choose to loosen these restrictions on the test set or do without one, I would strongly encourage you to think hard about it.</p>
</div>
<p>To get our test set, we could have split our initial data into 3.  Because we are a bit concerned about survivorship bias, let’s pull a new test set that uses recent data to and test how these strategies would perform over the last year and a half.</p>
<p>We need to get adjusted close price.  There are a variety of services that have APIs to pull from, I have picked polgygon to use here because it’s free for what we need.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are using a free api key and putting the key in this notebook in an effort to show everthing to the reader, but best practice would be to read the api key from an environment variable.  From the polygon docs it will by default pull the api key from the <code class="docutils literal notranslate"><span class="pre">POLYGON_API_KEY</span></code> environment variable, then you would initiate the client with so that no credentials are exposed.
<code class="docutils literal notranslate"><span class="pre">client</span> <span class="pre">=</span> <span class="pre">RESTClient()</span></code></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">polygon_free_api_key</span> <span class="o">=</span> <span class="s1">&#39;wUv2tpS05klv9ebAQKyLD610FBWllpan&#39;</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">RESTClient</span><span class="p">(</span><span class="n">polygon_free_api_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;polytest_eod-quotemedia.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">L</span><span class="p">()</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">L</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aggs</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_aggs</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2022-05-31&quot;</span><span class="p">,</span><span class="n">adjusted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">close</span> <span class="o">=</span> <span class="p">{</span><span class="n">ticker</span><span class="p">:[</span><span class="n">o</span><span class="o">.</span><span class="n">close</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">aggs</span><span class="p">]}</span>
            
            <span class="c1"># Convert millisecond time stamp to date</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">timestamp</span><span class="o">/</span><span class="mf">1e3</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">aggs</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">)</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">close</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">date</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aggs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAILURE: </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Free api gives 5 API calls / minute - so we need to pace our api calls!</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;polytest_eod-quotemedia.csv&#39;</span><span class="p">)</span>

<span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;polytest_eod-quotemedia.csv&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">,:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>AAL</th>
      <th>AAP</th>
      <th>AAPL</th>
      <th>ABBV</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-01-04</th>
      <td>118.64</td>
      <td>15.13</td>
      <td>157.34</td>
      <td>129.41</td>
      <td>105.41</td>
    </tr>
    <tr>
      <th>2021-01-05</th>
      <td>119.61</td>
      <td>15.43</td>
      <td>157.17</td>
      <td>131.01</td>
      <td>106.50</td>
    </tr>
    <tr>
      <th>2021-01-06</th>
      <td>122.89</td>
      <td>15.52</td>
      <td>166.25</td>
      <td>126.60</td>
      <td>105.58</td>
    </tr>
    <tr>
      <th>2021-01-07</th>
      <td>126.16</td>
      <td>15.38</td>
      <td>167.67</td>
      <td>130.92</td>
      <td>106.71</td>
    </tr>
    <tr>
      <th>2021-01-08</th>
      <td>127.06</td>
      <td>15.13</td>
      <td>170.06</td>
      <td>132.05</td>
      <td>107.27</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="what-metric-should-you-use-for-testing">
<h2><span class="section-number">2.3. </span>What metric should you use for testing?<a class="headerlink" href="#what-metric-should-you-use-for-testing" title="Permalink to this headline">#</a></h2>
<p>Now that we understand what data we will use for testing, let’s start figuring out how well our first model from chapter 1 performs.</p>
<p>The next step is to figure out an appropriate metric.  There are a variety of ways to measure this and we will walk through a few first steps in this section</p>
<section id="dollars">
<h3><span class="section-number">2.3.1. </span>Dollars<a class="headerlink" href="#dollars" title="Permalink to this headline">#</a></h3>
<p>Let’s take our first model from chapter 1 and measure how well it does in terms of dollars.  After all dollars is what we want to make, so it seems like a reasonable starting point.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">SimpleTimeSeries</span> <span class="kn">import</span> <span class="n">get_momentum_actions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">view_source_code</span><span class="p">(</span><span class="n">get_momentum_actions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2021 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2021 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #008800; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #AA22FF; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #008800; font-style: italic } /* Comment.Hashbang */
body .cm { color: #008800; font-style: italic } /* Comment.Multiline */
body .cp { color: #008800 } /* Comment.Preproc */
body .cpf { color: #008800; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #008800; font-style: italic } /* Comment.Single */
body .cs { color: #008800; font-weight: bold } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #AA22FF; font-weight: bold } /* Keyword.Constant */
body .kd { color: #AA22FF; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #AA22FF; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #AA22FF } /* Keyword.Pseudo */
body .kr { color: #AA22FF; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #00BB00; font-weight: bold } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BB4444 } /* Literal.String */
body .na { color: #BB4444 } /* Name.Attribute */
body .nb { color: #AA22FF } /* Name.Builtin */
body .nc { color: #0000FF } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #00A000 } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #B8860B } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BB4444 } /* Literal.String.Affix */
body .sb { color: #BB4444 } /* Literal.String.Backtick */
body .sc { color: #BB4444 } /* Literal.String.Char */
body .dl { color: #BB4444 } /* Literal.String.Delimiter */
body .sd { color: #BB4444; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BB4444 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BB4444 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BB4444 } /* Literal.String.Single */
body .ss { color: #B8860B } /* Literal.String.Symbol */
body .bp { color: #AA22FF } /* Name.Builtin.Pseudo */
body .fm { color: #00A000 } /* Name.Function.Magic */
body .vc { color: #B8860B } /* Name.Variable.Class */
body .vg { color: #B8860B } /* Name.Variable.Global */
body .vi { color: #B8860B } /* Name.Variable.Instance */
body .vm { color: #B8860B } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_momentum_actions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n_periods</span><span class="p">,</span><span class="n">threshold</span><span class="p">):</span>
    <span class="n">_x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n_periods</span><span class="p">)</span>

    <span class="c1"># Calculate percent change</span>
    <span class="n">momentum_rate</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n_periods</span><span class="p">))</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n_periods</span><span class="p">))[</span><span class="n">n_periods</span><span class="p">:]</span>

    <span class="c1"># Select Action Based on Threshold</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">momentum_rate</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;Short&#39;</span><span class="p">,</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">momentum_rate</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span>  <span class="s1">&#39;Buy&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;&#39;</span><span class="p">)),</span>
                   <span class="n">columns</span><span class="o">=</span><span class="n">momentum_rate</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">momentum_rate</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Because we use close price, we can&#39;t make the trade action until the following day</span>
    <span class="n">actions</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">actions</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">actions</span>
</pre></div>
</body>
</html>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid_mom</span> <span class="o">=</span> <span class="n">get_momentum_actions</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mf">0.08</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">valid_mom</span><span class="p">,</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transactions</span><span class="o">.</span><span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
<span class="n">transactions</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open_date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">L</span><span class="p">(</span><span class="o">*</span><span class="n">transactions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>open_date</th>
      <th>ticker</th>
      <th>action</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2017-02-14</td>
      <td>A</td>
      <td>Buy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2017-02-16</td>
      <td>A</td>
      <td>Buy</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2017-03-02</td>
      <td>A</td>
      <td>Buy</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2017-03-04</td>
      <td>A</td>
      <td>Buy</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2017-03-07</td>
      <td>A</td>
      <td>Buy</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we have a dataframe with all the positions we are going to take and when to take them.  But we are missing one crucial piece!  When should we close those positions.  We cannot make money by simplying buying a stock (ignoring dividends for now) - the profit comes when we actually close the position and sell the stock.  Let’s close the position 28 days after opening.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">open_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transactions</span><span class="o">.</span><span class="n">open_date</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">open_date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">28</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>open_date</th>
      <th>ticker</th>
      <th>action</th>
      <th>close_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2017-02-14</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-14</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2017-02-16</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-16</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2017-03-02</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-30</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2017-03-04</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-04-01</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2017-03-07</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-04-04</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Next we need to get the stock price on the date of our initial action when we open to position, as well as when we close our position.  Let’s start with the price on the day we open.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_valid_long</span> <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_valid_long</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dte&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;adj_close&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;open_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">open_date</span><span class="p">)</span>
<span class="n">df_valid_long</span><span class="p">[</span><span class="s1">&#39;dte&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_valid_long</span><span class="o">.</span><span class="n">dte</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">transactions</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;open_date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
         <span class="n">right</span><span class="o">=</span><span class="n">df_valid_long</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dte&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
         <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>open_date</th>
      <th>ticker</th>
      <th>action</th>
      <th>close_date</th>
      <th>dte</th>
      <th>adj_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2017-02-14</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-14</td>
      <td>2017-02-14</td>
      <td>49.703267</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2017-02-16</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-16</td>
      <td>2017-02-16</td>
      <td>50.147135</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2017-03-02</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-30</td>
      <td>2017-03-02</td>
      <td>50.679775</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2017-03-04</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-04-01</td>
      <td>NaT</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2017-03-07</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-04-04</td>
      <td>2017-03-07</td>
      <td>50.512092</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2017-03-11</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-04-08</td>
      <td>NaT</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2017-03-16</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-04-13</td>
      <td>2017-03-16</td>
      <td>52.327016</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2017-03-18</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-04-15</td>
      <td>NaT</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2017-05-24</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-06-21</td>
      <td>2017-05-24</td>
      <td>58.568656</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2017-05-25</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-06-22</td>
      <td>2017-05-25</td>
      <td>58.637875</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Uh oh - We have a join that isn’t working correctly and get <code class="docutils literal notranslate"><span class="pre">NaT</span></code> and <code class="docutils literal notranslate"><span class="pre">NaN</span></code>!  We created our model assuming that we could make transactions any day we want, but the stock market is not open every day.  There are limitations to when we can trade openly in the stock market we need to start accounting for.</p>
<p>When we trade using the adjusted close price we added a day because we wouldn’t be able to actually place the trade until the following day.  If that day ended up being a Saturday in reality we would have to wait until Monday to place that trade (assuming that monday isn’t a holiday).</p>
<p>Let’s fix that by getting the next available trading day for each date.  Because we know this same thing applies to our <code class="docutils literal notranslate"><span class="pre">close_date</span></code>, we will fix it there as well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unique_dates</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">valid</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">unique_dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_next_trading_day</span><span class="p">(</span><span class="n">dte</span><span class="p">,</span><span class="n">unique_dates</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">unique_dates</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">dte</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">get_next_trading_day</span><span class="p">,</span><span class="n">unique_dates</span><span class="o">=</span><span class="n">unique_dates</span><span class="p">)</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;open_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">open_date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">close_date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;open_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">open_date</span><span class="p">)</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">close_date</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can merge in the price correctly!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">transactions</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;open_date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                         <span class="n">right</span><span class="o">=</span><span class="n">df_valid_long</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dte&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                          <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">transactions</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                         <span class="n">right</span><span class="o">=</span><span class="n">df_valid_long</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dte&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                          <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                          <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_atOpen&#39;</span><span class="p">,</span><span class="s1">&#39;_atClose&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>open_date</th>
      <th>ticker</th>
      <th>action</th>
      <th>close_date</th>
      <th>dte_atOpen</th>
      <th>adj_close_atOpen</th>
      <th>dte_atClose</th>
      <th>adj_close_atClose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2017-02-14</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-14</td>
      <td>2017-02-14</td>
      <td>49.703267</td>
      <td>2017-03-14</td>
      <td>51.498464</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2017-02-16</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-16</td>
      <td>2017-02-16</td>
      <td>50.147135</td>
      <td>2017-03-16</td>
      <td>52.327016</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2017-03-02</td>
      <td>A</td>
      <td>Buy</td>
      <td>2017-03-30</td>
      <td>2017-03-02</td>
      <td>50.679775</td>
      <td>2017-03-30</td>
      <td>52.593336</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_committed</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Buy&#39;</span><span class="p">,</span><span class="s1">&#39;Short&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">adj_close_atOpen</span>  
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;committed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_committed</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f_revenue</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">action</span><span class="o">==</span><span class="s2">&quot;Buy&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">adj_close_atClose</span>
    <span class="k">else</span><span class="p">:</span>               <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">adj_close_atOpen</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;revenue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_revenue</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f_cost</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;Buy&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">adj_close_atOpen</span>  
    <span class="k">else</span><span class="p">:</span>                 <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">adj_close_atClose</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_cost</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">revenue</span> <span class="o">-</span> <span class="n">transactions</span><span class="o">.</span><span class="n">cost</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;committed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_committed</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;revenue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_revenue</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_cost</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">revenue</span> <span class="o">-</span> <span class="n">transactions</span><span class="o">.</span><span class="n">cost</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_dollars</span><span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="n">transactions</span><span class="o">.</span><span class="n">action</span><span class="o">==</span><span class="s1">&#39;Buy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> \
<span class="n">get_dollars</span><span class="p">(</span><span class="n">transactions</span><span class="p">[</span><span class="n">transactions</span><span class="o">.</span><span class="n">action</span><span class="o">==</span><span class="s1">&#39;Short&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> \
<span class="n">get_dollars</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;$7457.36&#39;, &#39;$190.98&#39;, &#39;$7648.35&#39;)
</pre></div>
</div>
</div>
</div>
<p>Great!  So according to our validation set we made a good chunk of profit (pre-tax).  We could buy/short in higher volumes (ie Buy = 10x buys, Short = 10x shorts) to make this profit larger.</p>
<p>However, this really isn’t enough information to determine whether that is a good idea of feasible.  I would love to loan someone 100 dollars if they would give me one-thousand dollars back a week later.  I would hate to loan someone 1,000,000 dollars on the promise that they would pay me 1,000,900 dollars back in 20 years.  The reward just wouldn’t be worth the risk, and I can use that money better in a 20-year span than that.</p>
<p>Let’s see if we can come up with a better metric that accounts for this.</p>
</section>
<section id="percent-return">
<h3><span class="section-number">2.3.2. </span>Percent Return<a class="headerlink" href="#percent-return" title="Permalink to this headline">#</a></h3>
<p>Instead of measuring raw dollars, lets consider how much money (capital) we needed in order to make that 90 dollars profit.  To do this we need to keep track of our money more carefully than just looking at how much we made at the end.  Let’s track out financials by day instead of by transaction o calculate this.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I am using “committed” to be the amount we have invested + the amount leveraged.  For now, let’s assume that we won’t take out debt and borrow stocks (shorting) if we do not have the capital to cover the initial price we borrowed at</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;open_date&#39;</span><span class="p">,</span><span class="s1">&#39;committed&#39;</span><span class="p">],[</span><span class="s1">&#39;close_date&#39;</span><span class="p">,</span><span class="s1">&#39;profit&#39;</span><span class="p">],[</span><span class="s1">&#39;close_date&#39;</span><span class="p">,</span><span class="s1">&#39;revenue&#39;</span><span class="p">],[</span><span class="s1">&#39;open_date&#39;</span><span class="p">,</span><span class="s1">&#39;cost&#39;</span><span class="p">]]:</span>
    <span class="n">_tmp</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">_tmp</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>committed</th>
      <th>profit</th>
      <th>revenue</th>
      <th>cost</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-06-05</th>
      <td>0.000000</td>
      <td>592.080365</td>
      <td>14911.585787</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2017-05-08</th>
      <td>14339.022800</td>
      <td>32.304898</td>
      <td>3399.317397</td>
      <td>14319.505423</td>
    </tr>
    <tr>
      <th>2017-04-07</th>
      <td>4412.945734</td>
      <td>-123.014397</td>
      <td>9870.114203</td>
      <td>4442.112622</td>
    </tr>
    <tr>
      <th>2017-05-26</th>
      <td>17276.320469</td>
      <td>205.866797</td>
      <td>6563.956562</td>
      <td>17278.061712</td>
    </tr>
    <tr>
      <th>2017-04-12</th>
      <td>3687.480711</td>
      <td>-192.747736</td>
      <td>9694.742256</td>
      <td>3742.820575</td>
    </tr>
    <tr>
      <th>2017-06-14</th>
      <td>0.000000</td>
      <td>439.297530</td>
      <td>14335.640007</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2017-03-06</th>
      <td>14327.219162</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>14312.335144</td>
    </tr>
    <tr>
      <th>2017-05-22</th>
      <td>10979.862236</td>
      <td>112.880645</td>
      <td>5323.332394</td>
      <td>11005.641604</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we can easily look at when we had the most committed.  We are subtracting revenue because once we get money back we can reinvest rather than using new money.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">capital_needed</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">committed</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">-</span><span class="n">df</span><span class="o">.</span><span class="n">revenue</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">get_dollars</span><span class="p">(</span><span class="n">capital_needed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;$274744.63&#39;
</pre></div>
</div>
</div>
</div>
<p>And of course our profit is still the same as we had before because we are just aggregating the data differently.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is the first time we are using the <a class="reference external" href="https://fastcore.fast.ai/test.html">fastcore’s testing framework</a>.  It has several handy and easy to use testing functions, such as testing if 2 numbers are arbitrarily close (useful for floats).</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_close</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">df</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="n">get_dollars</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;$7648.35&#39;
</pre></div>
</div>
</div>
</div>
<p>Now that we see our capital needed and our profit, let’s calculate a percent return</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sa">f</span><span class="s2">&quot;Percent Return: </span><span class="si">{</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">capital_needed</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Percent Return: 2.78%&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="log-return">
<h3><span class="section-number">2.3.3. </span>Log Return<a class="headerlink" href="#log-return" title="Permalink to this headline">#</a></h3>
<p>More commonly rather than using the percent return we want to use the log return.  There are a lot of reasons they are advantageous to use that will be covered throughout the book as they are significant to what we are doing.  For now we will cover one that is immediately useful to us.</p>
<p><strong>Symmetry / Additive</strong></p>
<ul class="simple">
<li><p>Percent Return</p>
<ul>
<li><p>Invest 100 dollars</p></li>
<li><p>Get 50% Return on investment 1 and reinvest</p></li>
<li><p>Get -50% Return on investment 2</p></li>
<li><p>End with <strong>75</strong> dollars</p></li>
</ul>
</li>
<li><p>Log Return</p>
<ul>
<li><p>Invest 100 dollars</p></li>
<li><p>Get 50% Return on investment 1 and reinvest</p></li>
<li><p>Get -50% Return on investment 2</p></li>
<li><p>End with <strong>100</strong> dollars</p></li>
</ul>
</li>
</ul>
<p>This property where a positive return + an equal-sized negative return = no return makes it much easier to look at returns and figure out if you are winning or losing.  Just add up all your log returns to get your overall log return.  You have to be much more careful with percent returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pt</span> <span class="o">=</span> <span class="n">capital_needed</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">pt_1</span> <span class="o">=</span> <span class="n">capital_needed</span>
<span class="n">log_return</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pt</span><span class="o">/</span><span class="n">pt_1</span><span class="p">)</span>
<span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pt</span><span class="o">/</span><span class="n">pt_1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;2.75%&#39;
</pre></div>
</div>
</div>
</div>
<p>As we calculate the log return we see we get a very similar value to our percent return, but it’s not exactly the same.  The advantage of using the log return however is we can accurate get an estimated annualized return.</p>
<p>This is great because we can easily have everything thought of as an annualized return so that we have a common time frame to compare investment strategies more easily.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">days</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">log_return</span><span class="o">/</span><span class="n">time_period</span> <span class="o">*</span> <span class="mi">365</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;7.37%&#39;
</pre></div>
</div>
</div>
</div>
<p>Now we can just convert to normal return to compare very simply to S&amp;P 500 annual return</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_return</span><span class="o">/</span><span class="n">time_period</span> <span class="o">*</span> <span class="mi">365</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;7.65%&#39;
</pre></div>
</div>
</div>
</div>
<p>Go ahead an look up S&amp;P 500 annual returns for each year online and compare.  How does this fare?</p>
</section>
</section>
<section id="statistical-tests">
<h2><span class="section-number">2.4. </span>Statistical Tests<a class="headerlink" href="#statistical-tests" title="Permalink to this headline">#</a></h2>
<section id="motivation">
<h3><span class="section-number">2.4.1. </span>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">#</a></h3>
<p>If you bought fifty 1.50 dollar lottery tickets and won 10 million dollars in the lottery, what could you say about your chances to win?  Well let’s calculate our rate of return.</p>
<div class="math notranslate nohighlight">
\[\frac{10,000,000 - 75}{75} = 133,332.33\]</div>
<p>So based on our calculations, the rate of return for playing the lottery is fantastic.  But we know that this doesn’t really reflect reality or mean that it’s a good safe investment strategy.  We know that you would’ve just gotten lucky.</p>
<p>So how do we determine if our trading strategy is a good strategy, or we just got lucky this time?  This is where statistical testing comes in.</p>
<p>I will cover the basics that I think are key, but if you’d like more detail and practice I reading <a class="reference external" href="https://www.lock5stat.com/">Statistics: Unlocking the Power of Data</a>.  Unlike most statistics book it is extremely applied and focused on data, with lots of real world examples.</p>
</section>
<section id="bootstrapping">
<h3><span class="section-number">2.4.2. </span>Bootstrapping<a class="headerlink" href="#bootstrapping" title="Permalink to this headline">#</a></h3>
<section id="id1">
<h4><span class="section-number">2.4.2.1. </span>Background<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h4>
<p>Statistical testing can be done be done using 2 general approaches.  The first is the classical approach with is the most widely known.  The second is through bootstrapping.  This chapter will focus on bootstrapping because in my opinion it is the first that should be learned.</p>
<p>Bootstrapping is less commonly accepted but is the more powerful and flexible of the two.  In bootstrapping you create a sampling distribution by by taking many samples and performing an experiment.  In traditional testing you use clever algebra to approximate a sampling distribution.  With todays computer you can almost always use bootstrapping and I believe it it the more powerful and flexible approach.</p>
<p>With Bootstrapping you start with just the data and make no other assumptions about the data.  With classical methods you start with the data and some assumptions about the data in order to arrive at an answer.  If you make incorrect assumptions then you get an incorrect answer - and determining which assumptions are safe to make is not always trivial.</p>
<p>The idea of bootstrapping and the power of it has also been spoken of by many of the statistical greats for almost 100 years, much longer than it was feasible to do, <a class="reference external" href="https://www.lock5stat.com/Lock5Overview.pdf">as pointed out in this article</a>.</p>
<p>For example, that article points out that in 1936 Sir R.A. Fisher spoke about using this bootstrapping approach:</p>
<blockquote>
<div><p>Actually, the statistician does not carry out this very simple and very tedious process, but his conclusions have no justification beyond the fact that they agree with those which could have been arrived at by this elementary method.</p>
</div></blockquote>
<p>However while these methods were tedious in 1936, they are trivial thanks to modern computers.  We no longer have to do clever algebraic tricks to approximate a sampling distribution - we can just create a sampling distribution.</p>
<p>That said, I do believe it’s good and useful to have the ability to use both approaches.  Luckily, traditional testing is just algebraic tricks to approximate what we will do here and so it will not be too hard to pick that up on top of bootstrapping.  In this section we will focus on Bootstrapping because in my opinion it is the one that should be learned first.</p>
<p>Please see our chapter on “Bootstrapping vs Classical Statistics” for more detail and understanding on both methods and information on how traditional statistics are really just estimations of a sampling distribution for when you do not have enough compute to actually create the sampling distributions.</p>
</section>
<section id="bootstrap-test">
<h4><span class="section-number">2.4.2.2. </span>Bootstrap Test<a class="headerlink" href="#bootstrap-test" title="Permalink to this headline">#</a></h4>
<p>With any type of testing we need to understand what we are testing.  We are going to have 2 competing hypothesis.  The first in the <strong>null hypothesis</strong>.  The null hypothesis is what we assume to be true, until we have evidence otherwise.</p>
<p>In the context of trading strategies we might make the hypothesis that our strategy will yield returns equal to that of randomly picking stocks.  If we randomly pick stocks we know that it will roughly match the market so that seems like a reasonable thing to want to beat.  The null hypothesis is important because our goal of testing is to determine whether we have sufficient evident to reject that null hypothesis.</p>
<p>The alternate hypothesis is what we are testing for.  For example, if the null hypothesis is that our strategy will yield returns equal that that of investing in random stocks the alternate hypothesis could be that our strategy will yield returns greater than if we were to invest in random stocks.</p>
<p>First we need a few functions:</p>
<ul class="simple">
<li><p>A function to run our null hypothesis model (random)</p></li>
<li><p>A function to run the model we created and have been exploring throughout the chapter</p></li>
<li><p>A function to measure the statistic of each run (log return of the models)</p></li>
</ul>
<p>We will look in the next chapter on better ways to organize this code, how to speed it up and run in parallel, and the like, but the focus here in general concepts.  We will use our understanding of these concepts in the next chapter to structure this better.</p>
<section id="null-hypothesis-model">
<h5><span class="section-number">2.4.2.2.1. </span>Null Hypothesis Model<a class="headerlink" href="#null-hypothesis-model" title="Permalink to this headline">#</a></h5>
<p>Let’s design a Null Hypothesis.  There are many Null Hypothesis’ you can choose, and one of the beauty of bootstrapping is that you can think about it very intuitively and design the experiment exactly how you want easier.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_random</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span><span class="n">buy_chance</span><span class="p">,</span><span class="n">short_chance</span><span class="p">,</span><span class="n">hold_time</span><span class="p">):</span>
    <span class="n">input_df_long</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1"># Buy/Short stocks using random chance, probabilities to be passed as arguements</span>
    <span class="n">buys</span> <span class="o">=</span> <span class="n">input_df_long</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">input_df_long</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;</span><span class="n">buy_chance</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">shorts</span> <span class="o">=</span> <span class="n">input_df_long</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">input_df_long</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;</span><span class="n">short_chance</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Concatenate into 1 dataframe</span>
    <span class="n">buys</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Buy&#39;</span>
    <span class="n">shorts</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Short&#39;</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">buys</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;action&#39;</span><span class="p">]],</span>
                            <span class="n">shorts</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;action&#39;</span><span class="p">]]])</span>
    
    <span class="c1"># Close the positions</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hold_time</span><span class="p">)</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transactions</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hold_time</span><span class="p">))]</span>
    
    <span class="c1"># Adjust dates for when market is open</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">get_next_trading_day</span><span class="p">,</span><span class="n">unique_dates</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="o">*</span><span class="n">input_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">close_date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">transactions</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="alternate-hypothesis-model">
<h5><span class="section-number">2.4.2.2.2. </span>Alternate Hypothesis Model<a class="headerlink" href="#alternate-hypothesis-model" title="Permalink to this headline">#</a></h5>
<p>We also need a model that we are hoping performs well that we are trying to evaluate whether it is better than our random null hypothesis or not.  For this, we will just use the model we have been working on throughout the chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span><span class="n">n_periods</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">hold_time</span><span class="p">):</span>
    <span class="n">valid_mom</span> <span class="o">=</span> <span class="n">get_momentum_actions</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span><span class="n">n_periods</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">valid_mom</span><span class="p">,</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transactions</span><span class="o">.</span><span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hold_time</span><span class="p">)</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transactions</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hold_time</span><span class="p">))]</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">get_next_trading_day</span><span class="p">,</span><span class="n">unique_dates</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="o">*</span><span class="n">input_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">close_date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">transactions</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-returns">
<h5><span class="section-number">2.4.2.2.3. </span>Calculate Returns<a class="headerlink" href="#calculate-returns" title="Permalink to this headline">#</a></h5>
<p>Next, we need a function that can take our 2 different model outputs (for null and alternate hypothesis) and calculate the statistic we care about (log return).  We do this by drawing on our work earlier in the chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_returns</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span><span class="n">input_df</span><span class="p">):</span>
    <span class="n">input_df_long</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="c1"># Merge in stock prices</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">transactions_df</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                             <span class="n">right</span><span class="o">=</span><span class="n">input_df_long</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">transactions</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                             <span class="n">right</span><span class="o">=</span><span class="n">input_df_long</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                              <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_atOpen&#39;</span><span class="p">,</span><span class="s1">&#39;_atClose&#39;</span><span class="p">))</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">[[</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;action&#39;</span><span class="p">,</span><span class="s1">&#39;date_atOpen&#39;</span><span class="p">,</span><span class="s1">&#39;adj_close_atOpen&#39;</span><span class="p">,</span><span class="s1">&#39;date_atClose&#39;</span><span class="p">,</span><span class="s1">&#39;adj_close_atClose&#39;</span><span class="p">]]</span>

    <span class="c1"># Calculate profit for each transaction</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;committed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_committed</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;revenue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_revenue</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_cost</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">revenue</span> <span class="o">-</span> <span class="n">transactions</span><span class="o">.</span><span class="n">cost</span>

    <span class="c1"># Create Daily dataframe</span>
    <span class="n">df_daily</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;date_atOpen&#39;</span><span class="p">,</span><span class="s1">&#39;committed&#39;</span><span class="p">],[</span><span class="s1">&#39;date_atClose&#39;</span><span class="p">,</span><span class="s1">&#39;profit&#39;</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;date_atClose&#39;</span><span class="p">,</span><span class="s1">&#39;revenue&#39;</span><span class="p">],[</span><span class="s1">&#39;date_atOpen&#39;</span><span class="p">,</span><span class="s1">&#39;cost&#39;</span><span class="p">]]:</span>
        <span class="n">_tmp</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df_daily</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_daily</span><span class="p">,</span><span class="n">_tmp</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_daily</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_daily</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Calculate Log Return</span>
    <span class="n">pt_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_daily</span><span class="o">.</span><span class="n">committed</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">-</span><span class="n">df_daily</span><span class="o">.</span><span class="n">revenue</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">pt_1</span> <span class="o">+</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pt</span><span class="o">/</span><span class="n">pt_1</span><span class="p">)</span>

<span class="n">calculate_returns</span><span class="p">(</span><span class="n">run_model</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mf">0.08</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span><span class="n">valid</span><span class="p">),</span>\
<span class="n">calculate_returns</span><span class="p">(</span><span class="n">run_random</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="mf">.1</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span><span class="n">valid</span><span class="p">),</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.0274575941649795, 0.03693321219133915)
</pre></div>
</div>
</div>
</div>
</section>
<section id="statistical-test">
<h5><span class="section-number">2.4.2.2.4. </span>Statistical Test<a class="headerlink" href="#statistical-test" title="Permalink to this headline">#</a></h5>
<p>Now that we have the setup let’s start our test.  First for our random model we need to give it a buy and short chance probability.  Let’s assume roughly even volume of trades to keep things simple and get the probabilities from our model.  In this way our random model trades at the same volume and frequency, just using random selection instead of momentum selection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span> <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">run_model</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mf">0.08</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
<span class="n">buy_chance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">action</span><span class="o">==</span><span class="s1">&#39;Buy&#39;</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_long</span><span class="p">)</span>
<span class="n">short_chance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">action</span><span class="o">==</span><span class="s1">&#39;Short&#39;</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_long</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model buy percentage=</span><span class="si">{</span><span class="n">buy_chance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model buy percentage=</span><span class="si">{</span><span class="n">short_chance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model buy percentage=0.08691717171717171
Model buy percentage=0.04311919191919192
</pre></div>
</div>
</div>
</div>
<p>Great - Let’s bind these to a function.  This is a functional programming principle that is extremely common in functional languages in the form of currying.  Python isn’t quite as convenient so we use <a class="reference external" href="https://fastcore.fast.ai/basics.html#bind">fastcore’s bind</a> for this (which is like the more common <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial">functool partial</a>, with a few added conveniences).</p>
<p>This allows us to pass our model functions as parameters which will be convenient when we want to try different parameters.  We could also just have all the parameters for either function as arguments in the main <code class="docutils literal notranslate"><span class="pre">run_bootstrap_test</span></code> function, but that can get rather clunky and confusing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_h0</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">run_random</span><span class="p">,</span><span class="n">buy_chance</span><span class="o">=</span><span class="n">buy_chance</span><span class="p">,</span><span class="n">short_chance</span><span class="o">=</span><span class="n">short_chance</span><span class="p">,</span><span class="n">hold_time</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we get to the meat of bootstrapping.  Really all we are doing is tacking different samples and running both models many times on different samples.  In classical statistics the normal distribution or some other distribution is assumed so that we can approximate a sampling distribution.  In bootstrapping we just create the sampling distribution directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_bootstrap_test</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span><span class="n">model_h0</span><span class="p">,</span><span class="n">runs</span><span class="p">,</span><span class="n">sample_size</span><span class="p">):</span>
    <span class="n">r_h0</span> <span class="o">=</span> <span class="n">L</span><span class="p">()</span>
    <span class="n">input_df_long</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">unique_tickers</span> <span class="o">=</span> <span class="n">input_df_long</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="n">ticker_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">unique_tickers</span><span class="p">,</span><span class="n">sample_size</span><span class="p">)</span> 
        <span class="n">valid_sample</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">[</span><span class="n">ticker_sample</span><span class="p">]</span>

        <span class="n">t_h0</span> <span class="o">=</span> <span class="n">model_h0</span><span class="p">(</span><span class="n">valid_sample</span><span class="p">)</span>

        <span class="n">r_h0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_returns</span><span class="p">(</span><span class="n">t_h0</span><span class="p">,</span><span class="n">valid</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r_h0</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-experiment">
<h5><span class="section-number">2.4.2.2.5. </span>Plot Experiment<a class="headerlink" href="#plot-experiment" title="Permalink to this headline">#</a></h5>
<p>It’s always helpful to visualize whatever you can.  Visualizing the data will help you build intuition, generate additional ideas, spot outliers, and identify possible errors in your code.  Let’s start with plotting our initial parameters we are using.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">model_h0</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">run_random</span><span class="p">,</span><span class="n">buy_chance</span><span class="o">=</span><span class="n">buy_chance</span><span class="p">,</span><span class="n">short_chance</span><span class="o">=</span><span class="n">short_chance</span><span class="p">,</span><span class="n">hold_time</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">model_h1</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">run_model</span><span class="p">,</span><span class="n">n_periods</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span><span class="n">hold_time</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
    
<span class="n">runs</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span><span class="mi">100</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">run_bootstrap_test</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">model_h0</span><span class="p">,</span><span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span><span class="n">sample_size</span><span class="o">=</span><span class="n">ss</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;h0&#39;</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">calculate_returns</span><span class="p">(</span><span class="n">model_h1</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span><span class="n">valid</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">title_r1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h0 mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">title_r2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h1 value=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_r1</span> <span class="o">+</span> <span class="n">title_r2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">Input In [41],</span> in <span class="ni">&lt;cell line: 11&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;h0&#39;</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>
<span class="ne">---&gt; </span><span class="mi">11</span> <span class="n">x</span> <span class="o">=</span> <span class="n">calculate_returns</span><span class="p">(</span><span class="n">model_h1</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span><span class="n">valid</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="n">title_r1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h0 mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/fastcore/basics.py:765,</span> in <span class="ni">bind.__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">763</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">_Arg</span><span class="p">):</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">764</span> <span class="n">fargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_Arg</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargs</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxi</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
<span class="ne">--&gt; </span><span class="mi">765</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">fargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">Input In [36],</span> in <span class="ni">run_model</span><span class="nt">(input_df, n_periods, threshold, hold_time)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">f</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">get_next_trading_day</span><span class="p">,</span><span class="n">unique_dates</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="o">*</span><span class="n">input_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="n">transactions</span><span class="p">[</span><span class="s1">&#39;close_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">transactions</span><span class="o">.</span><span class="n">close_date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="k">return</span> <span class="n">transactions</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/pandas/core/series.py:4433,</span> in <span class="ni">Series.apply</span><span class="nt">(self, func, convert_dtype, args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">4323</span> <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">4324</span>     <span class="bp">self</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">4325</span>     <span class="n">func</span><span class="p">:</span> <span class="n">AggFuncType</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">4328</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">4329</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span> <span class="o">|</span> <span class="n">Series</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">4330</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">4331</span><span class="sd">     Invoke function on values of Series.</span>
<span class="g g-Whitespace">   </span><span class="mi">4332</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">4431</span><span class="sd">     dtype: float64</span>
<span class="g g-Whitespace">   </span><span class="mi">4432</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">4433</span>     <span class="k">return</span> <span class="n">SeriesApply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">convert_dtype</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/pandas/core/apply.py:1082,</span> in <span class="ni">SeriesApply.apply</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1078</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1079</span>     <span class="c1"># if we are a string, try to dispatch</span>
<span class="g g-Whitespace">   </span><span class="mi">1080</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_str</span><span class="p">()</span>
<span class="ne">-&gt; </span><span class="mi">1082</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_standard</span><span class="p">()</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/pandas/core/apply.py:1137,</span> in <span class="ni">SeriesApply.apply_standard</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1131</span>         <span class="n">values</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">_values</span>
<span class="g g-Whitespace">   </span><span class="mi">1132</span>         <span class="c1"># error: Argument 2 to &quot;map_infer&quot; has incompatible type</span>
<span class="g g-Whitespace">   </span><span class="mi">1133</span>         <span class="c1"># &quot;Union[Callable[..., Any], str, List[Union[Callable[..., Any], str]],</span>
<span class="g g-Whitespace">   </span><span class="mi">1134</span>         <span class="c1"># Dict[Hashable, Union[Union[Callable[..., Any], str],</span>
<span class="g g-Whitespace">   </span><span class="mi">1135</span>         <span class="c1"># List[Union[Callable[..., Any], str]]]]]&quot;; expected</span>
<span class="g g-Whitespace">   </span><span class="mi">1136</span>         <span class="c1"># &quot;Callable[[Any], Any]&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1137</span>         <span class="n">mapped</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">map_infer</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1138</span>             <span class="n">values</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1139</span>             <span class="n">f</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
<span class="g g-Whitespace">   </span><span class="mi">1140</span>             <span class="n">convert</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_dtype</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1141</span>         <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1143</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapped</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ABCSeries</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1144</span>     <span class="c1"># GH#43986 Need to do list(mapped) in order to get treated as nested</span>
<span class="g g-Whitespace">   </span><span class="mi">1145</span>     <span class="c1">#  See also GH#25959 regarding EA support</span>
<span class="g g-Whitespace">   </span><span class="mi">1146</span>     <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_constructor_expanddim</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mapped</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/pandas/_libs/lib.pyx:2870,</span> in <span class="ni">pandas._libs.lib.map_infer</span><span class="nt">()</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/fastcore/basics.py:765,</span> in <span class="ni">bind.__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">763</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">_Arg</span><span class="p">):</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">764</span> <span class="n">fargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_Arg</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargs</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxi</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
<span class="ne">--&gt; </span><span class="mi">765</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">fargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">Input In [19],</span> in <span class="ni">get_next_trading_day</span><span class="nt">(dte, unique_dates)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">get_next_trading_day</span><span class="p">(</span><span class="n">dte</span><span class="p">,</span><span class="n">unique_dates</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="k">return</span> <span class="n">unique_dates</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">dte</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/fastcore/foundation.py:159,</span> in <span class="ni">L.filter</span><span class="nt">(self, f, negate, gen, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span> <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">noop</span><span class="p">,</span> <span class="n">negate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">159</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">filter_ex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">negate</span><span class="o">=</span><span class="n">negate</span><span class="p">,</span> <span class="n">gen</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

<span class="nn">File ~/miniconda3/envs/fin-bots/lib/python3.9/site-packages/fastcore/basics.py:603,</span> in <span class="ni">filter_ex</span><span class="nt">(iterable, f, negate, gen, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">601</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">602</span> <span class="k">if</span> <span class="n">gen</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
<span class="ne">--&gt; </span><span class="mi">603</span> <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="nn">Input In [19],</span> in <span class="ni">get_next_trading_day.&lt;locals&gt;.&lt;lambda&gt;</span><span class="nt">(x)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">get_next_trading_day</span><span class="p">(</span><span class="n">dte</span><span class="p">,</span><span class="n">unique_dates</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="k">return</span> <span class="n">unique_dates</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">dte</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
<img alt="_images/102_BasicTesting_89_1.png" src="_images/102_BasicTesting_89_1.png" />
</div>
</div>
<p>The blue histogram is the distribution of our random sampling.  The Red is our models return.  Visually the red point seems perfectly in line with the random distribution, but let’s be a bit more scientific about it.  Let’s calculate the p-value, and talk about what that means.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span><span class="o">&gt;</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">runs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.405
</pre></div>
</div>
</div>
</div>
<p>The p-value tells us the percentage of samples from our randomized null hypothesis trials that are more extreme than our model’s return.  Roughly 40% of the time we get a more unusual result just using our random selection - which tells us that from this look our model is pretty indistinguishable from our random model.</p>
<p>Said in statistical jargon, we failed to reject the null hypothesis.</p>
<p>Let’s try something else</p>
</section>
<section id="what-if-we-hold-for-less-time">
<h5><span class="section-number">2.4.2.2.6. </span>What if we hold for less time?<a class="headerlink" href="#what-if-we-hold-for-less-time" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">model_h0</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">run_random</span><span class="p">,</span><span class="n">buy_chance</span><span class="o">=</span><span class="n">buy_chance</span><span class="p">,</span><span class="n">short_chance</span><span class="o">=</span><span class="n">short_chance</span><span class="p">,</span><span class="n">hold_time</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">model_h1</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">run_model</span><span class="p">,</span><span class="n">n_periods</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span><span class="n">hold_time</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    
<span class="n">runs</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span><span class="mi">100</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">run_bootstrap_test</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">model_h0</span><span class="p">,</span><span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span><span class="n">sample_size</span><span class="o">=</span><span class="n">ss</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;h0&#39;</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">calculate_returns</span><span class="p">(</span><span class="n">model_h1</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span><span class="n">valid</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">title_r1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h0 mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">title_r2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h1 value=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_r1</span> <span class="o">+</span> <span class="n">title_r2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x176ac3f40&gt;
</pre></div>
</div>
<img alt="_images/102_BasicTesting_95_1.png" src="_images/102_BasicTesting_95_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span><span class="o">&gt;</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">runs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.395
</pre></div>
</div>
</div>
</div>
<p>This isn’t any better.  But that’s ok, because that’s how the process works.  Most of your experiments will fail, and this was only our first model.  Let’s try one more idea.</p>
</section>
<section id="what-if-we-use-a-larger-period-size-for-momentum">
<h5><span class="section-number">2.4.2.2.7. </span>What if we use a larger period size for momentum?<a class="headerlink" href="#what-if-we-use-a-larger-period-size-for-momentum" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">model_h0</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">run_random</span><span class="p">,</span><span class="n">buy_chance</span><span class="o">=</span><span class="n">buy_chance</span><span class="p">,</span><span class="n">short_chance</span><span class="o">=</span><span class="n">short_chance</span><span class="p">,</span><span class="n">hold_time</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">model_h1</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">run_model</span><span class="p">,</span><span class="n">n_periods</span><span class="o">=</span><span class="mi">56</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span><span class="n">hold_time</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
    
<span class="n">runs</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span><span class="mi">100</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">run_bootstrap_test</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">model_h0</span><span class="p">,</span><span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span><span class="n">sample_size</span><span class="o">=</span><span class="n">ss</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;h0&#39;</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">.15</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">calculate_returns</span><span class="p">(</span><span class="n">model_h1</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span><span class="n">valid</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">title_r1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h0 mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">title_r2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h1 value=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_r1</span> <span class="o">+</span> <span class="n">title_r2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x1767503d0&gt;
</pre></div>
</div>
<img alt="_images/102_BasicTesting_99_1.png" src="_images/102_BasicTesting_99_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h0</span><span class="p">)</span><span class="o">&gt;</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">runs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.005
</pre></div>
</div>
</div>
</div>
<p>Now we’re talking!  A very small percentage of the values from our random model are more extreme than the one we got with our model.</p>
<p>But now this invites a new question - how small does the p-value need to be to reject the null hypothesis?  0.05 is the most common and many people use this by default, but <strong>what your p-value threshold is is a design choice and trede-off that has real implications on your testing</strong>.  This is something to carefully consider.  Remember, testing is our only objective signal for whether we are doing something right or not so it deserves the most care and consideration.</p>
<p>Let’s consider the extremes so that we can easily thing about the trade-off.</p>
<p><strong>What if the p-value threshold we pick is large (ie 0.5)?</strong>*</p>
<p>With a p-value threshold of 0.5, we accept anything where less than 50% of the values from the randomized null hypothesis tests are more extreme.  The risk of this means that we will have a lot of false positives.  Said another way, LOTS of stuff will pass our test many of them just because of luck.</p>
<p>Said simply, we will think a lot of bad ideas are good ideas.</p>
<p><strong>What if the p-value threshold we pick is small (ie 0.000001)?</strong>*</p>
<p>With a p-value this small almost nothing will pass the test, but if it does we can be pretty confident in it!  The problem with this is many good ideas will fail the test just because of bad luck.</p>
<p>Said simply, we will have a lot of good ideas that we won’t realize are good ideas.  These are missed opportunities.</p>
<p><strong>The Tradeoff</strong></p>
<p>So really the P value is a trade-off.  A lower P value is more cautious and safe but you will miss out on some opportunities.  A high P value is riskier and more of your approaches will turn out to fail.</p>
<p>More details will come throughout the book on this, but it is important to understand that this is a tradeoff.  For a more detailed guide to testing read the hypothesis testing material in <a class="reference external" href="https://www.lock5stat.com/">Statistics: Unlocking the Power of Data</a></p>
</section>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="101_SimpleTimeSeries.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">1. </span>Simple Time Series (Stock Prices)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="104_TimeSeries.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Time Series</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Isaac Flath & Felix Flath<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>